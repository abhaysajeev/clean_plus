[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Overtime Checkin",
  "enabled": 1,
  "modified": "2025-08-12 14:27:11.994673",
  "module": "Clean Plus",
  "name": "Overtime Checkin Calculation",
  "script": "// --- Parent Doctype: Overtime Checkin ---\nfrappe.ui.form.on('Overtime Checkin', {\n    employee: function(frm) {\n        // Fetch employee name on employee selection\n        frappe.db.get_value(\"Employee\", frm.doc.employee, \"employee_name\", function(r) {\n            frm.set_value(\"employee_name\", r.employee_name);\n        });\n    },\n\n    validate: function(frm) {\n        // Ensure total overtime is always updated on save\n        update_total_overtime(frm);\n    }\n});\n\n\n// --- Child Table: Overtime Sessions ---\nfrappe.ui.form.on('Overtime Sessions', {\n    log_type: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n\n        if (row.log_type === \"OUT\" && row.time) {\n            let index = frm.doc.overtime_sessions.findIndex(r => r.name === row.name);\n            let previous_in_time = null;\n\n            // Find previous IN with time\n            for (let i = index - 1; i >= 0; i--) {\n                let entry = frm.doc.overtime_sessions[i];\n                if (entry.log_type === \"IN\" && entry.time) {\n                    previous_in_time = entry.time;\n                    break;\n                }\n            }\n\n            if (previous_in_time) {\n                // Parse IN and OUT times\n                let [in_h, in_m, in_s = 0] = previous_in_time.split(\":\").map(Number);\n                let [out_h, out_m, out_s = 0] = row.time.split(\":\").map(Number);\n\n                let in_seconds = in_h * 3600 + in_m * 60 + in_s;\n                let out_seconds = out_h * 3600 + out_m * 60 + out_s;\n\n                let diff_seconds = out_seconds - in_seconds;\n\n                if (diff_seconds > 0) {\n                    let hours = Math.floor(diff_seconds / 3600);\n                    let minutes = Math.floor((diff_seconds % 3600) / 60);\n                    let seconds = diff_seconds % 60;\n\n                    let session_time_str = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;\n\n                    frappe.model.set_value(cdt, cdn, 'session_duration', session_time_str);\n\n                    frm.refresh_field(\"overtime_sessions\");\n\n                    // Update total overtime in parent\n                    update_total_overtime(frm);\n                } else {\n                    frappe.msgprint(\"Out time must be after In time.\");\n                }\n            }\n        }\n    },\n\n    time: function(frm, cdt, cdn) {\n        // Trigger log_type logic if time changes on OUT row\n        let row = locals[cdt][cdn];\n        if (row.log_type === \"OUT\") {\n            frm.script_manager.trigger('log_type', cdt, cdn);\n        }\n    }\n});\n\n\n// --- Utility: Calculate and update total_overtime in parent ---\nfunction update_total_overtime(frm) {\n    let total_seconds = 0;\n\n    frm.doc.overtime_sessions.forEach(row => {\n        if (row.log_type === \"OUT\" && row.session_duration) {\n            let [h, m, s = 0] = row.session_duration.split(\":\").map(Number);\n            total_seconds += h * 3600 + m * 60 + s;\n        }\n    });\n\n    let total_hours = Math.floor(total_seconds / 3600);\n    let total_minutes = Math.floor((total_seconds % 3600) / 60);\n    let total_seconds_remaining = total_seconds % 60;\n\n    let total_overtime_str = `${String(total_hours).padStart(2, '0')}:${String(total_minutes).padStart(2, '0')}:${String(total_seconds_remaining).padStart(2, '0')}`;\n\n    frm.set_value(\"total_overtime\", total_overtime_str);\n    frm.refresh_field(\"total_overtime\");\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Security Gate Checkin",
  "enabled": 1,
  "modified": "2025-08-13 12:02:04.140075",
  "module": "Clean Plus",
  "name": "Security Gate Checkin Conditions",
  "script": "frappe.ui.form.on('Security Gate Checkin', {\n\temployee: function(frm) {\n        // Fetch employee name on employee selection\n        frappe.db.get_value(\"Employee\", frm.doc.employee, \"employee_name\", function(r) {\n            frm.set_value(\"employee_name\", r.employee_name);\n        });\n    },\n\n    validate: function(frm) {\n        // Ensure total overtime is always updated on save\n        update_total_session_time(frm);\n    }\n});\n\nfrappe.ui.form.on('Security Gate Sessions', {\n\tlog_type: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n\n        if (row.log_type === \"OUT\" && row.time) {\n            let index = frm.doc.security_gate_sessions.findIndex(r => r.name === row.name);\n            let previous_in_time = null;\n\n            // Find previous IN with time\n            for (let i = index - 1; i >= 0; i--) {\n                let entry = frm.doc.security_gate_sessions[i];\n                if (entry.log_type === \"IN\" && entry.time) {\n                    previous_in_time = entry.time;\n                    break;\n                }\n            }\n\n            if (previous_in_time) {\n                // Parse IN and OUT times\n                let [in_h, in_m, in_s = 0] = previous_in_time.split(\":\").map(Number);\n                let [out_h, out_m, out_s = 0] = row.time.split(\":\").map(Number);\n\n                let in_seconds = in_h * 3600 + in_m * 60 + in_s;\n                let out_seconds = out_h * 3600 + out_m * 60 + out_s;\n\n                let diff_seconds = out_seconds - in_seconds;\n\n                if (diff_seconds > 0) {\n                    let hours = Math.floor(diff_seconds / 3600);\n                    let minutes = Math.floor((diff_seconds % 3600) / 60);\n                    let seconds = diff_seconds % 60;\n\n                    let session_time_str = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;\n\n                    frappe.model.set_value(cdt, cdn, 'session_duration', session_time_str);\n\n                    frm.refresh_field(\"security_gate_sessions\");\n\n                    // Update total overtime in parent\n                    update_total_session_time(frm);\n                } else {\n                    frappe.msgprint(\"Out time must be after In time.\");\n                }\n            }\n        }\n    },\n\n    time: function(frm, cdt, cdn) {\n        // Trigger log_type logic if time changes on OUT row\n        let row = locals[cdt][cdn];\n        if (row.log_type === \"OUT\") {\n            frm.script_manager.trigger('log_type', cdt, cdn);\n        }\n    }\n});\n\n// --- Utility: Calculate and update total_overtime in parent ---\nfunction update_total_session_time(frm) {\n    let total_seconds = 0;\n\n    frm.doc.overtime_sessions.forEach(row => {\n        if (row.log_type === \"OUT\" && row.session_duration) {\n            let [h, m, s = 0] = row.session_duration.split(\":\").map(Number);\n            total_seconds += h * 3600 + m * 60 + s;\n        }\n    });\n\n    let total_hours = Math.floor(total_seconds / 3600);\n    let total_minutes = Math.floor((total_seconds % 3600) / 60);\n    let total_seconds_remaining = total_seconds % 60;\n\n    let total_overtime_str = `${String(total_hours).padStart(2, '0')}:${String(total_minutes).padStart(2, '0')}:${String(total_seconds_remaining).padStart(2, '0')}`;\n\n    frm.set_value(\"total_session_time\", total_overtime_str);\n    frm.refresh_field(\"total_session_time\");\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee",
  "enabled": 1,
  "modified": "2025-07-17 11:11:06.500520",
  "module": "Clean Plus",
  "name": "Employee Add Ons",
  "script": "frappe.ui.form.on('Employee', {\n    cell_number: function(frm) {\n        if (!frm.doc.cell_number) return;\n\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Employee',\n                filters: [\n                    ['cell_number', '=', frm.doc.cell_number],\n                    ['name', '!=', frm.doc.name]\n                ],\n                fields: ['name', 'employee_name', 'cell_number', 'custom_employee_code']\n            },\n            callback: function(response) {\n                if (response.message && response.message.length > 0) {\n                    let table_html = `\n                        <div style=\"max-width: 700px; margin: auto; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; font-size: 13px;\">\n                            <div style=\"padding: 10px;\">\n                                <div class=\"table-responsive\">\n                                    <table style=\"width: 100%; border-collapse: separate; border-spacing: 0;\">\n                                        <thead style=\"background-color:#f8f9fa;\">\n                                            <tr>\n                                                <th style=\"padding: 6px 8px; text-align: left; border-bottom: 1px solid #ddd;\">Employee Code</th>\n                                                <th style=\"padding: 6px 8px; text-align: left; border-bottom: 1px solid #ddd;\">Employee Name</th>\n                                                <th style=\"padding: 6px 8px; text-align: left; border-bottom: 1px solid #ddd;\">Mobile</th>\n                                            </tr>\n                                        </thead>\n                                        <tbody>\n                    `;\n\n                    response.message\n                        .sort((a, b) => {\n                            const aCode = a.custom_employee_code || '';\n                            const bCode = b.custom_employee_code || '';\n                            return aCode.localeCompare(bCode);\n                        })\n                        .forEach(employee => {\n                            table_html += `\n                                <tr>\n                                    <td style=\"padding: 5px 8px; border-top: 1px solid #eee;\">${employee.custom_employee_code || ''}</td>\n                                    <td style=\"padding: 5px 8px; border-top: 1px solid #eee;\">\n                                        <a href=\"/app/employee/${employee.name}\" style=\"color:#007bff; text-decoration:underline;\">${employee.employee_name}</a>\n                                    </td>\n                                    <td style=\"padding: 5px 8px; border-top: 1px solid #eee;\">${employee.cell_number || ''}</td>\n                                </tr>\n                            `;\n                        });\n\n                    table_html += `\n                                        </tbody>\n                                    </table>\n                                </div>\n                            </div>\n                        </div>\n                    `;\n\n                    frappe.msgprint({\n                        title: __('Duplicate Employee List'),\n                        message: table_html,\n                        indicator: 'red'\n                    });\n                }\n            }\n        });\n    },\n    status: function (frm) {\n        if (frm.doc.status === \"Left\"){\n            frm.set_value(\"custom_verification_printed\", 0);\n            frm.refresh_field(\"custom_verification_printed\");\n        }\n        \n        \n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee",
  "enabled": 0,
  "modified": "2025-07-14 15:12:26.525832",
  "module": "Clean Plus",
  "name": "Employee Verification",
  "script": "frappe.listview_settings['Employee'] = {\n    onload: function (listview) {\n        listview.page.add_inner_button(__('Employee Verification'), function () {\n            open_employee_verification_dialog();\n        });\n    },\n\n};\n\nfunction open_employee_verification_dialog() {\n    let selected_employees = new Set();\n    let filtered_employees = [];\n\n    const dialog = new frappe.ui.Dialog({\n        title: __('Employee Verification'),\n        size: 'large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'filter_section'\n            },\n            {\n                fieldtype: 'HTML',\n                fieldname: 'bulk_action_section'\n            },\n            {\n                fieldtype: 'HTML',\n                fieldname: 'table_html'\n            }\n        ],\n        primary_action_label: 'Print Selected',\n        primary_action: () => {\n            if (selected_employees.size === 0) {\n                frappe.msgprint(__('Please select at least one employee.'));\n                return;\n            }\n        \n            const employee_names = [...selected_employees];\n\n        }\n\n         \n    });\n\n    dialog.show();\n\n    // Render dynamic filters using Frappe UI controls\n    const filter_section = dialog.get_field('filter_section').$wrapper;\n    filter_section.html(`<div class=\"filters\" style=\"display: flex; gap: 15px; margin-bottom: 10px;\"></div>`);\n\n    // Branch Filter\n    const branch_filter = frappe.ui.form.make_control({\n        df: {\n            fieldname: 'branch_filter',\n            label: 'Branch',\n            fieldtype: 'Link',\n            options: 'Branch',\n            change: () => fetch_employees()\n        },\n        parent: filter_section.find('.filters'),\n        render_input: true\n    });\n    branch_filter.make();\n\n    // Department Filter\n    const dept_filter = frappe.ui.form.make_control({\n        df: {\n            fieldname: 'department_filter',\n            label: 'Department',\n            fieldtype: 'Link',\n            options: 'Department',\n            change: () => fetch_employees()\n        },\n        parent: filter_section.find('.filters'),\n        render_input: true\n    });\n    dept_filter.make();\n\n    // Verification Status Filter\n    const status_filter = frappe.ui.form.make_control({\n        df: {\n            fieldname: 'status_filter',\n            label: 'Verification Status',\n            fieldtype: 'Select',\n            options: [\n                { label: 'Select', value: '' },\n                { label: 'Joining', value: 'Joining' },\n                { label: 'Relieving', value: 'Relieving' }\n            ],\n            change: () => fetch_employees()\n        },\n        parent: filter_section.find('.filters'),\n        render_input: true\n    });\n    status_filter.make();\n\n    // Section heading for employee table\n    const bulk_action_html = `\n        <div style=\"display: flex; justify-content: space-between; align-items: center; margin: 10px 0 5px;\">\n            <h5 style=\"margin: 0;\">Employee List</h5>\n        </div>\n    `;\n    dialog.get_field('bulk_action_section').$wrapper.html(bulk_action_html);\n\n    // Initial load\n    fetch_employees();\n\n    function fetch_employees() {\n        const branch = branch_filter.get_value();\n        const department = dept_filter.get_value();\n        const verification_status = status_filter.get_value();\n\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Employee',\n                filters: {\n                    custom_needs_employee_verification: 1,\n                    ...(branch && { branch }),\n                    ...(department && { department })\n                },\n                fields: ['name', 'employee_name', 'custom_referral_code', 'custom_aadhaar_number', 'status'],\n                limit: 100\n            },\n            callback: function (r) {\n                filtered_employees = r.message\n                    .map(emp => ({\n                        name: emp.name,\n                        employee_name: emp.employee_name,\n                        aadhar: emp.custom_aadhaar_number,\n                        referral: emp.custom_referral_code,\n                        status: emp.status === 'Active' ? 'Joining' : 'Relieving'\n                    }))\n                    .filter(emp => {\n                        if (!verification_status) return true;\n                        return emp.status === verification_status;\n                    });\n\n                render_table();\n            }\n        });\n    }\n\n    function render_table() {\n        const wrapper = dialog.get_field('table_html').$wrapper;\n        let html = `\n            <div class=\"table-responsive\" style=\"max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px;\">\n                <table class=\"table table-hover\" style=\"margin-bottom: 0;\">\n                    <thead style=\"position: sticky; top: 0; background: #f5f5f5; z-index: 1;\">\n                        <tr style=\"border-bottom: 1px solid #ccc;\">\n                            <th style=\"width:30px;\"><input type=\"checkbox\" id=\"select_all\" ${selected_employees.size === filtered_employees.length ? 'checked' : ''}></th>\n                            <th style=\"padding: 10px;\">Employee Name</th>\n                            <th style=\"padding: 10px;\">Aadhar No</th>\n                            <th style=\"padding: 10px;\">Joining or Relieving</th>\n                            <th style=\"padding: 10px;\">Referral Code</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n        `;\n\n        for (const emp of filtered_employees) {\n            const checked = selected_employees.has(emp.name) ? 'checked' : '';\n            html += `\n                <tr style=\"transition: background 0.2s;\">\n                    <td style=\"padding: 8px 12px;\"><input type=\"checkbox\" class=\"emp-checkbox\" data-name=\"${emp.name}\" ${checked}></td>\n                    <td style=\"padding: 8px 12px;\">${emp.employee_name}</td>\n                    <td style=\"padding: 8px 12px;\">${emp.aadhar || ''}</td>\n                    <td style=\"padding: 8px 12px;\">${emp.status}</td>\n                    <td style=\"padding: 8px 12px;\">${emp.referral || ''}</td>\n                </tr>\n            `;\n        }\n\n        html += `\n                    </tbody>\n                </table>\n            </div>\n        `;\n\n        wrapper.html(html);\n\n        // Handle select all\n        wrapper.find('#select_all').on('change', function () {\n            if (this.checked) {\n                filtered_employees.forEach(emp => selected_employees.add(emp.name));\n            } else {\n                selected_employees.clear();\n            }\n            render_table();\n        });\n\n        // Individual checkbox\n        wrapper.find('.emp-checkbox').on('change', function () {\n            const name = $(this).data('name');\n            if (this.checked) {\n                selected_employees.add(name);\n            } else {\n                selected_employees.delete(name);\n            }\n        });\n    }\n}\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Outpass Request",
  "enabled": 1,
  "modified": "2025-09-01 10:47:50.416494",
  "module": "Clean Plus",
  "name": "Outpass Request Script",
  "script": "frappe.ui.form.on('Outpass Request', {\n    employee: function(frm) {\n        frm.trigger(\"fetch_checkins_dialog\");\n    },\n    date: function(frm) {\n        frm.trigger(\"fetch_checkins_dialog\");\n    },\n\n    fetch_checkins_dialog: function(frm) {\n        if (!frm.doc.employee || !frm.doc.date) return;\n\n        frappe.call({\n            method: \"sil_v2.services.movements.get_employee_checkins\",\n            args: {\n                employee: frm.doc.employee,\n                date: frm.doc.date\n            },\n            callback: function(r) {\n                if (r.message && r.message.length > 0) {\n                    let checkins = r.message;\n\n                    let d = new frappe.ui.Dialog({\n                        title: \"Select Outpass Checkins\",\n                        fields: [{ fieldtype: \"HTML\", fieldname: \"checkin_html\" }],\n                        primary_action_label: \"Save\",\n                        primary_action(values) {\n                            let selected = [];\n                            d.$wrapper.find(\"input[type=checkbox]:checked\").each(function() {\n                                let idx = $(this).data(\"idx\");\n                                selected.push(checkins[idx]);\n                            });\n\n                            // Validation: must be even number\n                            if (selected.length % 2 !== 0) {\n                                frappe.msgprint(__('Please select check-ins in pairs (even number).'));\n                                return;\n                            }\n\n                            // Clear child table before filling\n                            frm.clear_table(\"outpass_intervals\");\n\n                            // Add selected checkins into child table\n                            for (let i = 0; i < selected.length; i += 2) {\n                                if (selected[i] && selected[i+1]) {\n                                    let row = frm.add_child(\"outpass_intervals\");\n                                    row.out_checkin = selected[i].name;\n                                    row.from = selected[i].time;\n                                    row.in_checkin = selected[i+1].name;\n                                    row.to = selected[i+1].time;\n\n                                    // Calculate duration in hours (2 decimals)\n                                    let diff_minutes = moment(row.to).diff(moment(row.from), \"minutes\");\n                                    row.duration = (diff_minutes / 60).toFixed(2);\n                                }\n                            }\n\n                            frm.refresh_field(\"outpass_intervals\");\n                            frm.trigger(\"calculate_total_duration\"); // update parent field\n                            d.hide();\n                        }\n                    });\n\n                    // Render checkin list with checkboxes\n                    let html = `<table class=\"table table-bordered\">\n                        <tr><th>Select</th><th>Time</th><th>Log Type</th></tr>`;\n                    checkins.forEach((log, idx) => {\n                        html += `<tr>\n                            <td><input type=\"checkbox\" data-idx=\"${idx}\"></td>\n                            <td>${log.time}</td>\n                            <td>${log.log_type}</td>\n                        </tr>`;\n                    });\n                    html += `</table>`;\n                    d.fields_dict.checkin_html.$wrapper.html(html);\n\n                    d.show();\n                } else {\n                    frappe.msgprint(\"No checkins found for this employee on this date.\");\n                }\n            }\n        });\n    },\n\n    // Recalculate parent total when child table changes\n    calculate_total_duration: function(frm) {\n        let total = 0;\n        (frm.doc.outpass_intervals || []).forEach(row => {\n            total += flt(row.duration);\n        });\n        frm.set_value(\"total_duration\", total.toFixed(2)); // parent field\n    }\n});\n\n// When child table rows are manually edited, recalc duration and total\nfrappe.ui.form.on('Outpass Intervals', {\n    from: function(frm, cdt, cdn) {\n        calculate_row_duration(frm, cdt, cdn);\n    },\n    to: function(frm, cdt, cdn) {\n        calculate_row_duration(frm, cdt, cdn);\n    },\n    outpass_intervals_remove: function(frm) {\n        frm.trigger(\"calculate_total_duration\");\n    }\n});\n\nfunction calculate_row_duration(frm, cdt, cdn) {\n    let row = frappe.get_doc(cdt, cdn);\n    if (row.from && row.to) {\n        let diff_minutes = moment(row.to).diff(moment(row.from), \"minutes\");\n        row.duration = (diff_minutes / 60).toFixed(2);\n        frm.refresh_field(\"outpass_intervals\");\n        frm.trigger(\"calculate_total_duration\");\n    }\n}\n",
  "view": "Form"
 }
]